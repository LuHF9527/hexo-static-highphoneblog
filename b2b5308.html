<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="renderer" content="webkit"><title>Hashmap源码阅读笔记 | highPhone Space</title><link rel="shortcut icon" href="/images/favicon.png"><link rel="alternate" href="/atom.xml" title="highPhone Space" type="application/atom+xml"><meta name="description" content="JDK源码版本: Oracle JDK1.8.0_271  常量123456789101112&#x2F;&#x2F;默认的初始化容量static final int DEFAULT_INITIAL_CAPACITY &#x3D; 1 &lt;&lt; 4; &#x2F;&#x2F; aka 16   &#x2F;&#x2F;最大容量static final int MAXIMUM_CAPACITY &#x3D; 1 &lt;&lt; 30;&#x2F;&#x2F;加载因子static fin"><meta property="og:type" content="article"><meta property="og:title" content="Hashmap源码阅读笔记"><meta property="og:url" content="https://highphone.xyz/b2b5308.html"><meta property="og:site_name" content="highPhone Space"><meta property="og:description" content="JDK源码版本: Oracle JDK1.8.0_271  常量123456789101112&#x2F;&#x2F;默认的初始化容量static final int DEFAULT_INITIAL_CAPACITY &#x3D; 1 &lt;&lt; 4; &#x2F;&#x2F; aka 16   &#x2F;&#x2F;最大容量static final int MAXIMUM_CAPACITY &#x3D; 1 &lt;&lt; 30;&#x2F;&#x2F;加载因子static fin"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-03-05T14:42:00.000Z"><meta property="article:modified_time" content="2021-05-29T07:28:51.841Z"><meta property="article:author" content="highPhone啊"><meta property="article:tag" content="Hashmap"><meta name="twitter:card" content="summary"><meta name="format-detection" content="telephone=no,email=no"><meta name="theme-color" content="#9C27B0"><meta name="description" content="底层码农的爬坑笔记"><meta name="keywords" content=",Hashmap"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="highPhone Space"><meta name="msapplication-starturl" content="https://highphone.xyz/b2b5308.html"><meta name="msapplication-navbutton-color" content="#9C27B0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="highPhone Space"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/images/favicon.png"><meta property="article:published_time" content="Fri Mar 05 2021 22:42:00 GMT+0800"><meta property="article:modified_time" content="Sat May 29 2021 15:28:51 GMT+0800"><link rel="canonical" href="https://highphone.xyz/b2b5308.html"><link rel="stylesheet" href="/css/mdui.css"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.2.0"></head><body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-indigo mdui-theme-accent-pink"><script>var a=localStorage.getItem("mdui-theme-layout-dark");a&&(document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark")</script><header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset"><div class="mdui-toolbar mdui-color-theme"><a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a> <a href="/" class="mdui-typo-headline">highPhone Space</a><div class="mdui-toolbar-spacer"></div><a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a> <a href="/atom.xml" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'RSS'}"><i class="mdui-icon material-icons">rss_feed</i></a></div></header><div class="mdui-dialog" id="search"><div class="search-form"><input type="search" class="search-form-input" placeholder="Enter the key words"></div><div class="search-result" data-resource="/search.xml"></div></div><aside id="sidebar" class="mdui-drawer mdui-drawer-full-height"><div class="mdui-grid-tile"><img src="/images/banner.png" style="height:160px"> <img src="/images/avatar.png" class="avatar-animation" style="position:absolute;top:10%;left:24px;width:64px;height:64px;border:2px solid #fff;border-radius:50%"><div class="mdui-grid-tile-actions"><div class="mdui-grid-tile-text"><div class="mdui-grid-tile-title">highPhone啊</div><div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>冲就完事了</div></div></div></div><div class="mdui-list" mdui-collapse="{accordion: true}"><a href="/" class="mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i><div class="mdui-list-item-content">主页</div></a><div class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i><div class="mdui-list-item-content">归档</div><i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i></div><div class="mdui-collapse-item-body mdui-list mdui-list-dense"><a class="mdui-ripple sidebar_archives-link" href="/archives/2023/03/">三月 2023<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/09/">九月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/12/">十二月 2020<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/11/">十一月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a></div></div><div class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i><div class="mdui-list-item-content">分类</div><i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i></div><div class="mdui-collapse-item-body mdui-list mdui-list-dense"><a class="mdui-ripple sidebar_archives-link" href="/categories/JavaWeb/">JavaWeb<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础<span class="mdui-ripple sidebar_archives-count">11</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%BC%AB%E8%B0%88/">漫谈<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E7%AE%97%E6%B3%95/">算法<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<span class="mdui-ripple sidebar_archives-count">2</span></a></div></div><div class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i><div class="mdui-list-item-content">标签</div><i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i></div><div class="mdui-collapse-item-body mdui-list mdui-list-dense"><a class="mdui-ripple sidebar_archives-none-link" href="/tags/Adapter/" rel="tag">Adapter<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/GC/" rel="tag">GC<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/Hashmap/" rel="tag">Hashmap<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/JMM/" rel="tag">JMM<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/Java/" rel="tag">Java<span class="mdui-ripple sidebar_archives-none-count">4</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">Lambda表达式<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/Markdown/" rel="tag">Markdown<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/String/" rel="tag">String<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/jvm/" rel="tag">jvm<span class="mdui-ripple sidebar_archives-none-count">4</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/leetcode/" rel="tag">leetcode<span class="mdui-ripple sidebar_archives-none-count">2</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/mysql/" rel="tag">mysql<span class="mdui-ripple sidebar_archives-none-count">3</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/servlet/" rel="tag">servlet<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/singleton/" rel="tag">singleton<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" rel="tag">动态规划<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程<span class="mdui-ripple sidebar_archives-none-count">2</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/%E5%AF%B9%E6%92%9E%E6%8C%87%E9%92%88/" rel="tag">对撞指针<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序<span class="mdui-ripple sidebar_archives-none-count">2</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构<span class="mdui-ripple sidebar_archives-none-count">1</span></a><a class="mdui-ripple sidebar_archives-none-link" href="/tags/%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/" rel="tag">算法基础<span class="mdui-ripple sidebar_archives-none-count">1</span></a></div></div><a href="/about" class="mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i><div class="mdui-list-item-content">关于</div></a></div><div class="mdui-divider"></div><div class="mdui-list" mdui-collapse="{accordion: true}"><a target="_blank" rel="noopener" href="https://github.com/LuHF9527" class="mdui-list-item mdui-ripple">Github</a><div class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"><div class="mdui-list-item-content">友情链接</div><i class="mdui-list-item-icon mdui-icon material-icons">link</i></div><div class="mdui-collapse-item-body mdui-list mdui-list-dense"><a href="" target="_blank" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme-accent" style="justify-content:center">土川的自留地</a> <a href="" target="_blank" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme-accent" style="justify-content:center">是老茶客啊</a></div></div></div></aside><main id="main" class="mdui-m-t-5 fadeIn animated"><link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"><style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style><article class="mdui-card mdui-m-b-5"><header class="mdui-card-media"><img src="/images/random/material-14.png" style="max-height:240px"><div class="mdui-card-media-covered"><div class="mdui-card-primary"><div class="mdui-card-primary-title">Hashmap源码阅读笔记</div><div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-03-05 / <i class="iconfont">&#xe601;</i> highPhone啊</div></div></div><div class="mdui-card-menu"><button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#qrcode', align: 'right'}"><i class="mdui-icon material-icons">devices</i></button><ul class="mdui-menu" id="qrcode"><li class="mdui-menu-item"><a class="mdui-text-center mdui-ripple">Send to mobile phone</a></li><li class="mdui-menu-item" disabled><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAAB6ElEQVR42u3awXLCMAwEUP7/p9trL8CulbbEfjkxQ2L8chCypMfXFtcDAwMDAwMDA+NjGI/4+nn/s8/Pnnp2z9oeMDAwzmS8CW3lT07Wz+/BwMA4k5EE2dfP5lvMAzcGBgZGu0QSWJPkb/4qMTAwMJJguhZA89eEgYGBMTpAxglftKG/P4tjYGDckHFVY2Dy+YP6GxgYGB/GqEcc4gZA0rD8t5kRDAyMWzHWymTz8Ys8WayHLTAwMLZjtIfPtcGvduX6EIuBgbE1oz245k+tJZ1JGoqBgXEaY615OTmUJong6H8DAwNjU0ZeoJ+HzmS16B4MDIzDGGtbfx0ci2ZkvA4GBgbGZEPzMNqW4TAwMM5hJC3MvFWZF/qLVmVeNcTAwNiasRYKJ4G1bZ1iYGCczMjTxJyUhM58FAwDAwOjLXWtDV7kAb0I6xgYGMcw1lK6diuTbzEwMDDmhbaoiF+G6QuGLTAwMLZj5FdCylPPydgHBgbGOYw28OXH2kmj9IL+BgYGxnaMNsgmqV7bNki+xcDAwGi30iaUSaGtaCdgYGBgXFRimzQJ3qSbGBgYGEuHzElorsfIMDAwjmS0P9A2Btog/ovlNgwMjBsy2sZAXnpbO9BGzU4MDIxjGPe9MDAwMDAwMDD+9foGjB/FOj/YN7IAAAAASUVORK5CYII="></li></ul><button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="mdui-icon material-icons">share</i></button><ul class="mdui-menu" id="share_menu"><li class="mdui-menu-item"><a href="http://service.weibo.com/share/share.php?appkey=&title=Hashmap源码阅读笔记&url=https://highphone.xyz/b2b5308.html&pic=https://highphone.xyz/images/favicon.png&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到微博</a></li><li class="mdui-menu-item"><a href="https://twitter.com/intent/tweet?text=Hashmap源码阅读笔记&url=https://highphone.xyz/b2b5308.html&via=highPhone啊" target="_blank" class="mdui-ripple">分享到Twitter</a></li><li class="mdui-menu-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://highphone.xyz/b2b5308.html" target="_blank" class="mdui-ripple">分享到Facebook</a></li><li class="mdui-menu-item"><a href="https://plus.google.com/share?url=https://highphone.xyz/b2b5308.html" target="_blank" class="mdui-ripple">分享到Google+</a></li><li class="mdui-menu-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://highphone.xyz/b2b5308.html&title=Hashmap源码阅读笔记" target="_blank" class="mdui-ripple">分享到LinkedIn</a></li><li class="mdui-menu-item"><a href="http://connect.qq.com/widget/shareqq/index.html?site=highPhone Space&title=Hashmap源码阅读笔记&summary=底层码农的爬坑笔记&pics=https://highphone.xyz/images/favicon.png&url=https://highphone.xyz/b2b5308.html" target="_blank" class="mdui-ripple">分享到QQ</a></li><li class="mdui-menu-item"><a href="https://telegram.me/share/url?url=https://highphone.xyz/b2b5308.html&text=Hashmap源码阅读笔记" target="_blank" class="mdui-ripple">分享到Telegram</a></li></ul></div></header><div class="mdui-card-content mdui-typo"><blockquote><p>JDK源码版本: Oracle JDK1.8.0_271</p></blockquote><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认的初始化容量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16   </span></span><br><span class="line"><span class="comment">//最大容量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"><span class="comment">//加载因子</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"><span class="comment">//由链表转化为红黑树的节点数量的阈值。</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="comment">//哈希桶数组某一下标下的Node链表节点数量大于此值，由红黑树转化为链表。此值要比TREEIFY_THRESHOLD小</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"><span class="comment">//当哈希桶数组容量大于等于此值，才会进行红黑树转化，否则对哈希桶数组进行resize()扩容操作</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br></pre></td></tr></table></figure><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* ---------------- Fields -------------- */</span></span><br><span class="line"> <span class="comment">//哈希桶数组，其长度必须是2的次方，在第一次使用时才会初始化，可以通过resize()方法扩容。</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用来缓存entrySet()方法的结果，当entrySet()被调用时优先从这个成员变量获取值，如果它为null，在去调用EntrySet内部类的构造函数，获取所有Entry的set集合，返回EntrySet实例的同时也将实例的引用赋给entrySet。以便下次entrySet()被调用时可以快速获取结果。</span></span><br><span class="line"><span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//Hashmap所包含键值对的总数</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HashMap实例的内部结构被修改的次数。用于快速失败</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下一次将进行扩容的容量。当某次插入操作之后，size大于threshold的时候，将进行扩容，threshold将变成下一次进行扩容的容量。</span></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"><span class="comment">//加载因子。它的作用,用来计算threshold：threshold = loadFactor * table.size。该值默认为0.75。</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br></pre></td></tr></table></figure><h3 id="静态方法hash-和tableSizeFor"><a href="#静态方法hash-和tableSizeFor" class="headerlink" title="静态方法hash()和tableSizeFor()"></a>静态方法hash()和tableSizeFor()</h3><ul><li><p>hash()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);<span class="comment">//高16位右移后与原值做异或计算</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数也叫<strong>扰动函数</strong>，在理解扰动函数前，我们要先知道在HashMap中，根据元素hashcode计算数组下标的方法是<code>(n-1) &amp; hash</code>,若果没有扰动函数重新计算key的hash值，那么，对于初始容量16来说，n-1的值为15，基于<code>(n-1) &amp; hash</code> 算出来的下标，只与hash值的最后4位有关，前28无论是何值，都不影响计算出来的下标，这样，发生<strong>hash碰撞</strong>的机率会比较高。<strong>扰动函数</strong>的作用就是让hash高16位与低16位的值做一个异或，让所有数值的特征结合到一起，尽量使hash值中每一位数值对下标的计算都有意义，降低<strong>hash碰撞</strong></p></li><li><p>tableSizeFor()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法是为了保证hash数组的长度一定是2的n次方，且返回的值是<strong>大于输入参数且最小的2的整数次幂的数</strong>, 我们用输入值9来做一个计算，就能很清楚的看到计算规则了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cap                 0000 0000 0000 0000 0000 0000 0000 1001</span><br><span class="line">n &#x3D; cap - 1         0000 0000 0000 0000 0000 0000 0000 1000</span><br><span class="line">n &gt;&gt;&gt; 1             0000 0000 0000 0000 0000 0000 0000 0100</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt;1         0000 0000 0000 0000 0000 0000 0000 1100</span><br><span class="line">n &gt;&gt;&gt; 2             0000 0000 0000 0000 0000 0000 0000 0011</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt;2         0000 0000 0000 0000 0000 0000 0000 1111</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">n &gt;&gt;&gt; 16            0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt;16        0000 0000 0000 0000 0000 0000 0000 1111</span><br></pre></td></tr></table></figure><p>上述计算中，有一步<code>n = cap - 1</code>操作，这一步是为了防止输入的cap刚好是2的整数次幂，如果不减1，计算结果最终会是预期值的2倍，同时，由于int只有32位，做到<code>n |= n &gt;&gt;&gt; 16</code>这一步时，已经可以确保32位全是1，这时计算结果为MAXIMUM_CAPACITY</p></li></ul><h3 id="添加元素putVal"><a href="#添加元素putVal" class="headerlink" title="添加元素putVal()"></a>添加元素putVal()</h3><p>此方法是往HashMap中添加元素的核心实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">//如果table数组为null或者table数组长度为0，说明是第一次进入，对table数组进行resize()初始化扩容</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//如果通过(n - 1) &amp; hash计算到的tab[index]中的节点为null，还没有hash碰撞，直接新建一个节点</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//有hash碰撞产生</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">//首先检查hash碰撞发生的那个数据下标所在元素，与此次添加进来的元素是否相等(hash相等且key相等)，如相等，替换此数组下标的节点</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">//如果发生hash碰撞的数组下标所在元素是TreeNode，证明此下标下的数据已经转化成红黑树存储了，调用putTreeVal()添加元素</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="comment">//发生hash碰撞的数组下标所在元素仍然以链表存储</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//遍历链表添加元素</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">//在链表尾部添加新元素</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//添加元素后检查链表长度，如果&gt;=7,转换成红黑树</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果key已存在，直接break出for循环，在后面代码中会覆盖旧值</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//key已存在mapping中，覆盖旧值</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;<span class="comment">//结构变化次数，有更新或删除操作时记录</span></span><br><span class="line">    <span class="comment">//如果size大于扩容阈值，size+1，resize()扩容</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="扩容机制resize"><a href="#扩容机制resize" class="headerlink" title="扩容机制resize()"></a>扩容机制resize()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//如果扩容前的容量已经是最大容量，直接返会旧的数组，只能让新元素在旧数组上添加，如果有hash碰撞，也无法扩容</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//新容量为旧容量的两倍，位运算左移1位</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="comment">//第一次初始化，threshold为0，使用默认容量和默认threshold</span></span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算新的resize阈值newThreshold</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//把旧的table数组中元素遍历复制到新的数组</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//把已经取出的元素置null，方便gc回收</span></span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//该元素既不是链表也不是红黑树，直接求出index放到新数组</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">//红黑树节点，调用TreeNode的split方法处理</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="comment">//该元素下有链表</span></span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="comment">//循环遍历复制链表</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote class="mdui-m-t-5"><strong>本文链接：</strong><a href="https://highphone.xyz/b2b5308.html">https://highphone.xyz/b2b5308.html</a></blockquote></div><footer class="mdui-card-actions"><a class="mdui-ripple article_categories-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a> <a class="mdui-ripple article_tags-none-link" href="/tags/Hashmap/" rel="tag">Hashmap</a></footer></article><script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script><script>$("#main article .mdui-card-content img.fancybox").on("click",function(c){$.fancybox.open({src:$(this).attr("src")})})</script><nav id="paginator"><a rel="prev" class="extend prev" href="/2a457b11.html"><button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇</a><div class="spacer"></div><a rel="next" class="extend next" href="/cff6dd61.html">下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button></a></nav></main><footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme"><div class="mdui-p-y-0 mdui-text-center"></div><div class="mdui-p-y-1 mdui-text-center">Copyright &copy; 2020 - 2023 highPhone啊<br>Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a></div></footer><button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button><script src="/js/mdui.js"></script><script src="/js/script.js"></script></body></html>